<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµçŒ«é€Ÿæ¨</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="overlay" id="overlay"></div>
    
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
        <nav class="top-nav">
            <div class="nav-left">
                <button class="menu-toggle" id="menuToggle">â˜°</button>
                <div class="nav-title">çµçŒ«é€Ÿæ¨</div>
            </div>
            <button class="refresh-btn" onclick="loadNewsList(true)">ğŸ”„</button>
        </nav>

        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">çµçŒ«é€Ÿæ¨</div>
                <div class="sidebar-subtitle">çƒ­ç‚¹æ–°é—»æ¯æ—¥æ¨é€ç³»ç»Ÿ</div>
            </div>
            <div class="sidebar-content" id="sidebarContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <div class="current-info" id="currentInfo" style="display: none;">
                å½“å‰æŸ¥çœ‹: <span id="currentTitle">-</span>
            </div>
            <div class="iframe-container">
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">ğŸ“°</div>
                    <div class="welcome-text">æ­£åœ¨åŠ è½½æœ€æ–°æ–°é—»...</div>
                </div>
                <iframe class="news-frame" id="newsFrame" style="display: none;"></iframe>
            </div>
        </main>
    </div>

    <script>
        let currentNewsData = null;
        let isFirstLoad = true;

        // Toastæç¤ºå‡½æ•°
        function showToast(message, type = 'info') {
            // ç§»é™¤å·²å­˜åœ¨çš„toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            // åˆ›å»ºæ–°toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // æ˜¾ç¤ºtoast
            setTimeout(() => toast.classList.add('show'), 10);

            // 3ç§’åéšè—å¹¶ç§»é™¤
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // åŠ è½½æ–°é—»åˆ—è¡¨
        async function loadNewsList(showFeedback = false) {
            const sidebarContent = document.getElementById('sidebarContent');
            const loading = sidebarContent.querySelector('.loading');
            
            if (loading) {
                loading.style.display = 'block';
            }

            try {
                const response = await fetch('api/news-list.json?t=' + Date.now());
                const data = await response.json();
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
                if (showFeedback && currentNewsData) {
                    const oldCount = currentNewsData.dates.reduce((sum, d) => sum + d.news.length, 0);
                    const newCount = data.dates.reduce((sum, d) => sum + d.news.length, 0);
                    
                    if (newCount > oldCount) {
                        showToast(`âœ¨ å‘ç° ${newCount - oldCount} æ¡æ–°æ–°é—»`, 'success');
                    } else if (JSON.stringify(currentNewsData) === JSON.stringify(data)) {
                        showToast('ğŸ“° å·²æ˜¯æœ€æ–°å†…å®¹', 'info');
                    } else {
                        showToast('ğŸ”„ åˆ—è¡¨å·²æ›´æ–°', 'success');
                    }
                }
                
                currentNewsData = data;
                renderNewsList(data);
                
                // é¦–æ¬¡åŠ è½½æ—¶è‡ªåŠ¨æ‰“å¼€æœ€æ–°æ–°é—»
                if (isFirstLoad && data.dates.length > 0 && data.dates[0].news.length > 0) {
                    isFirstLoad = false;
                    const latestDate = data.dates[0];
                    const latestNews = latestDate.news[0];
                    setTimeout(() => {
                        loadNewsAuto(latestNews.path, `${latestDate.date} ${latestNews.time}`);
                    }, 100);
                }
                
            } catch (error) {
                console.error('åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥:', error);
                sidebarContent.innerHTML = '<div style="padding: 20px; color: #ef4444; text-align: center;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                if (showFeedback) {
                    showToast('âŒ åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•', 'warning');
                }
            }
        }

        // æ¸²æŸ“æ–°é—»åˆ—è¡¨
        function renderNewsList(data) {
            const sidebarContent = document.getElementById('sidebarContent');
            
            let html = '';
            data.dates.forEach((dateItem, index) => {
                html += `
                    <div class="date-group ${index === 0 ? '' : 'collapsed'}" data-date="${dateItem.date}">
                        <div class="date-header" onclick="toggleDateGroup(this)">
                            <span>ğŸ“… ${dateItem.date}</span>
                            <span class="date-icon">â–¼</span>
                        </div>
                        <div class="news-list">
                            ${dateItem.news.map((news, newsIndex) => `
                                <div class="news-item ${index === 0 && newsIndex === 0 ? 'active' : ''}" onclick="loadNews('${news.path}', '${dateItem.date} ${news.time}')">
                                    ğŸ• ${news.time}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            sidebarContent.innerHTML = html;
        }

        // åˆ‡æ¢æ—¥æœŸç»„å±•å¼€/æŠ˜å 
        function toggleDateGroup(element) {
            const dateGroup = element.parentElement;
            dateGroup.classList.toggle('collapsed');
        }

        // åŠ è½½æ–°é—»å†…å®¹ï¼ˆç”¨æˆ·ç‚¹å‡»ï¼‰
        function loadNews(path, title) {
            const newsFrame = document.getElementById('newsFrame');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const currentTitle = document.getElementById('currentTitle');
            const currentInfo = document.getElementById('currentInfo');
            
            // æ›´æ–°æ ‡é¢˜
            currentTitle.textContent = title;
            currentInfo.style.display = 'block';
            
            // æ˜¾ç¤ºiframeï¼Œéšè—æ¬¢è¿å±å¹•
            welcomeScreen.style.display = 'none';
            newsFrame.style.display = 'block';
            
            // åŠ è½½æ–°é—»é¡µé¢
            newsFrame.src = path;
            
            // æ›´æ–°æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.news-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // å…³é—­ä¾§è¾¹æ 
            closeSidebar();
        }

        // è‡ªåŠ¨åŠ è½½æ–°é—»å†…å®¹ï¼ˆé¦–æ¬¡åŠ è½½ï¼‰
        function loadNewsAuto(path, title) {
            const newsFrame = document.getElementById('newsFrame');
            const welcomeScreen = document.getElementById('welcomeScreen');
            const currentTitle = document.getElementById('currentTitle');
            const currentInfo = document.getElementById('currentInfo');
            
            // æ›´æ–°æ ‡é¢˜
            currentTitle.textContent = title;
            currentInfo.style.display = 'block';
            
            // æ˜¾ç¤ºiframeï¼Œéšè—æ¬¢è¿å±å¹•
            welcomeScreen.style.display = 'none';
            newsFrame.style.display = 'block';
            
            // åŠ è½½æ–°é—»é¡µé¢
            newsFrame.src = path;
        }

        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        });

        overlay.addEventListener('click', closeSidebar);

        function closeSidebar() {
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', loadNewsList);
    </script>
</body>
</html>
